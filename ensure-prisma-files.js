// ensure-prisma-files.js
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

console.log('Ensuring Prisma files are present and correctly configured...');

// Function to ensure a directory exists
function ensureDirectoryExists(dirPath) {
  if (!fs.existsSync(dirPath)) {
    console.log(`Creating directory: ${dirPath}`);
    fs.mkdirSync(dirPath, { recursive: true });
    return true;
  }
  return false;
}

// Function to log directory contents
function logDirectoryContents(dirPath, label) {
  try {
    if (fs.existsSync(dirPath)) {
      console.log(`\n${label} directory contents:`);
      const files = fs.readdirSync(dirPath);
      files.forEach(file => {
        const fullPath = path.join(dirPath, file);
        const stats = fs.statSync(fullPath);
        console.log(`- ${file} (${stats.isDirectory() ? 'directory' : 'file'}, ${stats.size} bytes)`);
      });
    } else {
      console.log(`\n${label} directory does not exist.`);
    }
  } catch (error) {
    console.error(`Error reading ${label} directory:`, error);
  }
}

try {
  // 1. Ensure prisma directory exists
  const prismaDir = path.join(process.cwd(), 'prisma');
  ensureDirectoryExists(prismaDir);
  
  // 2. Check for schema.prisma
  const schemaPath = path.join(prismaDir, 'schema.prisma');
  if (!fs.existsSync(schemaPath)) {
    console.error('CRITICAL: schema.prisma file not found!');
    console.log('Searching for schema.prisma in other locations...');
    
    // Search for schema.prisma in common locations
    const possibleLocations = [
      path.join(process.cwd(), 'src', 'prisma', 'schema.prisma'),
      path.join(process.cwd(), 'app', 'prisma', 'schema.prisma'),
      path.join(process.cwd(), 'schema.prisma')
    ];
    
    let schemaFound = false;
    for (const location of possibleLocations) {
      if (fs.existsSync(location)) {
        console.log(`Found schema.prisma at ${location}`);
        // Copy it to the expected location
        fs.copyFileSync(location, schemaPath);
        console.log(`Copied schema.prisma to ${schemaPath}`);
        schemaFound = true;
        break;
      }
    }
    
    if (!schemaFound) {
      console.log('Creating minimal schema.prisma file...');
      
      // Create a minimal schema
      const minimalSchema = `// This is a minimal schema created during build
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  directUrl    = env("DIRECT_URL")
  relationMode = "prisma"
}

// Minimal User model
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
}
`;
      
      fs.writeFileSync(schemaPath, minimalSchema);
      console.log('Created minimal schema.prisma file');
    }
  } else {
    console.log('Found schema.prisma at expected location');
    
    // Check if schema.prisma has correct binary targets
    const schemaContent = fs.readFileSync(schemaPath, 'utf8');
    if (!schemaContent.includes('binaryTargets')) {
      console.log('Updating schema.prisma with binary targets...');
      
      const updatedSchema = schemaContent.replace(
        'generator client {',
        'generator client {\n  binaryTargets = ["debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]'
      );
      
      fs.writeFileSync(schemaPath, updatedSchema);
      console.log('Updated schema.prisma with binary targets');
    } else if (schemaContent.includes('"native"')) {
      console.log('Removing "native" from binary targets...');
      
      let updatedSchema = schemaContent;
      updatedSchema = updatedSchema.replace('"native",', '');
      updatedSchema = updatedSchema.replace(', "native"', '');
      updatedSchema = updatedSchema.replace('"native"', '"debian-openssl-3.0.x"');
      
      fs.writeFileSync(schemaPath, updatedSchema);
      console.log('Removed "native" from binary targets');
    }
  }
  
  // 3. Create client.npg.graphql file if missing
  const graphqlPath = path.join(prismaDir, 'client.npg.graphql');
  if (!fs.existsSync(graphqlPath)) {
    console.log(`Creating empty client.npg.graphql file...`);
    fs.writeFileSync(graphqlPath, '# GraphQL schema generated by Prisma\n');
    console.log('Created client.npg.graphql file');
  }
  
  // 4. Ensure Prisma client directory exists
  const prismaClientDir = path.join(process.cwd(), 'node_modules', '@prisma', 'client');
  ensureDirectoryExists(path.join(process.cwd(), 'node_modules', '@prisma'));
  ensureDirectoryExists(prismaClientDir);
  
  // 5. Ensure .prisma directory exists in node_modules
  const prismaBinariesDir = path.join(process.cwd(), 'node_modules', '.prisma');
  ensureDirectoryExists(prismaBinariesDir);
  
  // 6. Create engine_manifest.json file if missing
  const manifestPath = path.join(prismaBinariesDir, 'engine_manifest.json');
  if (!fs.existsSync(manifestPath)) {
    console.log(`Creating engine_manifest.json file...`);
    const manifest = {
      "version": "6.8.1",
      "engines": []
    };
    fs.writeFileSync(manifestPath, JSON.stringify(manifest, null, 2));
    console.log('Created engine_manifest.json file');
  }
  
  // 7. Log directory contents for debugging
  logDirectoryContents(process.cwd(), 'Root');
  logDirectoryContents(prismaDir, 'Prisma');
  logDirectoryContents(path.join(process.cwd(), 'node_modules', '@prisma'), '@prisma');
  logDirectoryContents(prismaBinariesDir, '.prisma');
  
  // 8. Print environment variables related to Prisma
  console.log('\nPrisma-related environment variables:');
  console.log('- PRISMA_BINARY_PLATFORM:', process.env.PRISMA_BINARY_PLATFORM || 'not set');
  console.log('- PRISMA_CLI_BINARY_TARGETS:', process.env.PRISMA_CLI_BINARY_TARGETS || 'not set');
  console.log('- PRISMA_CLIENT_ENGINE_TYPE:', process.env.PRISMA_CLIENT_ENGINE_TYPE || 'not set');
  console.log('- DATABASE_URL:', process.env.DATABASE_URL ? 'set (hidden)' : 'not set');
  console.log('- DIRECT_URL:', process.env.DIRECT_URL ? 'set (hidden)' : 'not set');
  
  console.log('\nPrisma files setup completed successfully');
} catch (error) {
  console.error('Error during Prisma files setup:', error);
  console.log('Continuing with build despite errors');
}
